<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Reminder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --sidebar-width: 220px;
            --primary-color: #2c80ff;
            --primary-dark: #1a6de8;
            --bg-color: #f5f7fa;
            --sidebar-bg: #2d3748;
            --text-color: #2d3748;
            --text-light: #718096;
            --border-color: #e2e8f0;
            --card-bg: #ffffff;
            --success-color: #48bb78;
            --warning-color: #ed8936;
        }

        /* Dark mode variables */
        .dark-mode {
            --bg-color: #1a202c;
            --sidebar-bg: #2d3748;
            --text-color: #e2e8f0;
            --text-light: #a0aec0;
            --border-color: #4a5568;
            --card-bg: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            /* Disable text selection globally */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Disable context menu */
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            transition: background-color 0.3s ease, color 0.3s ease;
            /* Additional protection */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Allow text selection only for input fields */
        input[type="text"],
        input[type="number"],
        textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* Disable right-click context menu globally */
        * {
            -webkit-context-menu: none;
            -moz-context-menu: none;
            context-menu: none;
        }

        /* Make buttons and interactive elements feel more app-like */
        .btn,
        .nav-item,
        .card,
        .sound-option,
        .badge-item,
        .achievement-card {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: pointer;
        }

        /* Disable text cursor on non-editable text */
        h1, h2, h3, h4, h5, h6,
        p, span, div,
        .stat-value,
        .stat-label,
        #countdown,
        .timer-label {
            cursor: default;
        }

        /* Disable selection on icons */
        i {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            pointer-events: none;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Water Wave Animation */
        .water-waves {
            position: absolute;
            bottom: 0;
            left: var(--sidebar-width);
            right: 0;
            height: 120px;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }

        .wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: linear-gradient(180deg, transparent, rgba(44, 128, 255, 0.1) 20%, rgba(44, 128, 255, 0.2) 40%, rgba(44, 128, 255, 0.1) 60%, transparent);
            animation: wave-animation 8s linear infinite;
            transform-origin: center bottom;
        }

        .wave:nth-child(2) {
            animation-delay: -4s;
            opacity: 0.7;
            background: linear-gradient(180deg, transparent, rgba(44, 128, 255, 0.15) 25%, rgba(44, 128, 255, 0.25) 45%, rgba(44, 128, 255, 0.15) 65%, transparent);
        }

        .wave:nth-child(3) {
            animation-delay: -2s;
            opacity: 0.5;
            background: linear-gradient(180deg, transparent, rgba(44, 128, 255, 0.1) 30%, rgba(44, 128, 255, 0.2) 50%, rgba(44, 128, 255, 0.1) 70%, transparent);
        }

        @keyframes wave-animation {
            0% {
                transform: translateX(0) translateZ(0) scaleY(1);
            }
            50% {
                transform: translateX(-25%) translateZ(0) scaleY(0.8);
            }
            100% {
                transform: translateX(-50%) translateZ(0) scaleY(1);
            }
        }

        /* Particle Effects */
        .particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: rgba(44, 128, 255, 0.6);
            border-radius: 50%;
            animation: float 6s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            50% {
                transform: translateY(-100px) translateX(20px);
            }
        }

        /* Animated Water Glass */
        .water-glass-container {
            position: relative;
            width: 120px;
            height: 160px;
            margin: 20px auto;
        }

        .water-glass {
            position: absolute;
            width: 80px;
            height: 120px;
            background: linear-gradient(90deg, #e2e8f0, #cbd5e0);
            border: 3px solid #cbd5e0;
            border-radius: 0 0 20px 20px;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            overflow: hidden;
        }

        .water-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(180deg, #2c80ff, #1a6de8);
            transition: height 1s ease-in-out;
            border-radius: 0 0 17px 17px;
        }

        .water-surface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            animation: water-shimmer 2s infinite;
        }

        @keyframes water-shimmer {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }

        .glass-stem {
            position: absolute;
            width: 10px;
            height: 30px;
            background: #cbd5e0;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
        }

        .glass-base {
            position: absolute;
            width: 50px;
            height: 10px;
            background: #cbd5e0;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 10px;
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            z-index: 2;
            position: relative;
        }

        .app-logo {
            display: flex;
            align-items: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .app-logo i {
            font-size: 24px;
            margin-right: 10px;
            color: var(--primary-color);
        }

        .app-logo h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-left: 3px solid transparent;
            user-select: none;
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary-color);
        }

        .nav-item:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .nav-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        #main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 2;
        }

        .content-section {
            display: none;
            flex-direction: column;
            flex: 1;
        }

        .content-section.active {
            display: flex;
        }

        .content-header {
            margin-bottom: 30px;
        }

        .content-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .content-header p {
            color: var(--text-light);
            font-size: 15px;
        }

        /* Cards Layout */
        .cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark-mode .card {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-header i {
            font-size: 20px;
            margin-right: 10px;
            color: var(--primary-color);
        }

        .card-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        /* Timer Display */
        .timer-display {
            text-align: center;
            margin: 20px 0;
        }

        #countdown {
            font-size: 48px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .timer-label {
            color: var(--text-light);
            font-size: 14px;
            margin-top: 5px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: #e2e8f0;
            color: var(--text-color);
        }

        .dark-mode .btn-secondary {
            background-color: #4a5568;
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background-color: #cbd5e0;
        }

        .dark-mode .btn-secondary:hover {
            background-color: #5a6578;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #38a169;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #dd771c;
        }

        /* Settings */
        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .setting-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .inline-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .inline-input input {
            width: 80px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: .4s;
            border-radius: 34px;
        }

        .dark-mode .slider {
            background-color: #4a5568;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background-color: var(--bg-color);
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-light);
        }

        /* Footer */
        .app-footer {
            margin-top: 20px;
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-light);
            font-size: 13px;
            position: relative;
            z-index: 2;
            flex-shrink: 0; /* Prevent footer from stretching */
        }

        .credits a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .credits a:hover {
            text-decoration: underline;
        }

        /* History Page */
        .history-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            font-weight: 500;
        }

        .history-date {
            color: var(--text-light);
            font-size: 14px;
        }

        .empty-history {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .empty-history i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* About Page */
        .about-content {
            max-width: 600px;
        }

        .about-section {
            margin-bottom: 25px;
        }

        .about-section h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .about-section p {
            line-height: 1.6;
            color: var(--text-light);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .dark-mode ::-webkit-scrollbar-track {
            background: #2d3748;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #5a6578;
        }

        /* Timer State */
        .timer-ticking {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(44, 128, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(44, 128, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(44, 128, 255, 0); }
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .dark-mode .progress-container {
            background-color: #4a5568;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Small Screen Warning */
        .small-screen-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .small-screen-warning.show {
            display: flex;
        }

        .small-screen-warning i {
            font-size: 64px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .small-screen-warning h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .small-screen-warning p {
            font-size: 16px;
            margin-bottom: 20px;
            max-width: 400px;
            line-height: 1.5;
        }

        /* Welcome Message */
        .welcome-message {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 5px;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 30px;
            z-index: 1000;
        }

        .theme-toggle-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .theme-toggle-btn:hover {
            background: var(--bg-color);
        }

        /* Enhanced Achievements */
        .achievement-card {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--bg-color);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s ease;
        }

        .achievement-card:hover {
            transform: translateX(5px);
        }

        .achievement-card.earned {
            border-left-color: var(--success-color);
        }

        .achievement-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .achievement-description {
            font-size: 12px;
            color: var(--text-light);
        }

        .achievement-badge {
            background: var(--success-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Sound Selector */
        .sound-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .sound-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .sound-option:hover {
            border-color: var(--primary-color);
        }

        .sound-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(44, 128, 255, 0.1);
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Celebration Animation */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10000;
            display: none;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary-color);
            animation: confetti-fall 3s ease-in-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* History Page Button Container */
        .history-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        /* Statistics Export Buttons */
        .stats-export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Badge Display Styles */
        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 17px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            min-height: 120px;
            align-items: center;
        }

        .badge-item {
            position: relative;
            width: 70px;
            height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            box-shadow: 0 4px 15px rgba(44, 128, 255, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .badge-item:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 8px 25px rgba(44, 128, 255, 0.5);
        }

        .badge-item.earned {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .badge-item.earned:hover {
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.5);
        }

        .badge-icon {
            font-size: 24px;
            color: white;
            margin-bottom: 2px;
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--card-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .badge-name {
            position: absolute;
            bottom: -25px;
            font-size: 10px;
            color: var(--text-color);
            text-align: center;
            white-space: nowrap;
            background: var(--card-bg);
            padding: 2px 6px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 10;
        }

        .badge-item:hover .badge-name {
            opacity: 1;
        }

        /* Shiny effect for badges */
        .badge-item::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .badge-item.earned::before {
            opacity: 1;
            animation: shiny 3s ease-in-out infinite;
        }

        @keyframes shiny {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        /* Empty badges state */
        .empty-badges {
            text-align: center;
            color: var(--text-light);
            padding: 20px;
        }

        .empty-badges i {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Badge tooltip */
        .badge-tooltip {
            position: absolute;
            bottom: -60px;
            background: var(--sidebar-bg);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .badge-item:hover .badge-tooltip {
            opacity: 1;
        }

        .badge-tooltip::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid var(--sidebar-bg);
        }

        .badge-count-small {
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 9px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
        }
        
        .achievement-count {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 2px;
        }
                /* Optimize cards container spacing */
        .cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px; /* Reduced from 30px */
        }

        /* Reduce content header margin */
        .content-header {
            margin-bottom: 20px; /* Reduced from 30px */
        }

        .content-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px; /* Reduced from 8px */
        }

        /* Optimize main content padding */
        #main-content {
            flex: 1;
            padding: 20px 30px; /* Reduced top padding from 30px */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 2;
        }

        /* Reduce card padding */
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px; /* Reduced from 24px */
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        /* Optimize badges container */
        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 15px; /* Reduced from 17px */
            padding: 15px; /* Reduced from 20px */
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            min-height: 100px; /* Reduced from 120px */
            align-items: center;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn" id="themeToggle">
            <i class="fas fa-moon"></i>
            <span>Dark Mode</span>
        </button>
    </div>

    <!-- Water Waves Animation -->
    <div class="water-waves">
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
    </div>

    <!-- Particles Container -->
    <div class="particles-container" id="particlesContainer"></div>

    <!-- Celebration Animation -->
    <div class="celebration" id="celebration"></div>

    <div class="main-container">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="app-logo">
                <i class="fas fa-tint"></i>
                <h1>Water Reminder</h1>
            </div>
            
            <div class="nav-item active" data-page="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-page="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </div>
            <div class="nav-item" data-page="statistics">
                <i class="fas fa-chart-bar"></i>
                <span>Statistics</span>
            </div>
            <div class="nav-item" data-page="achievements">
                <i class="fas fa-trophy"></i>
                <span>Achievements</span>
            </div>
            <div class="nav-item" data-page="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="nav-item" data-page="about">
                <i class="fas fa-info-circle"></i>
                <span>About</span>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Dashboard Page -->
            <div class="content-section active" id="dashboard-page">
                <div class="content-header">
                    <h2 id="greeting">Stay Hydrated</h2>
                    <p>Your health is important. I'll remind you to drink water regularly.</p>
                </div>

                <div class="cards-container">
                    <!-- Timer Card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="far fa-clock"></i>
                            <h3>Reminder Timer</h3>
                        </div>
                        <div class="timer-display">
                            <div id="countdown">01:00:00</div>
                            <div class="timer-label">Next reminder</div>
                        </div>
                        <div class="controls">
                            <button id="startBtn" class="btn btn-primary">
                                <i class="fas fa-play"></i> Start
                            </button>
                            <button id="stopBtn" class="btn btn-secondary" style="display: none;">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i>
                            <h3>Today's Progress</h3>
                        </div>
                        <div class="water-glass-container">
                            <div class="water-glass">
                                <div class="water-fill" id="waterFill" style="height: 0%"></div>
                                <div class="water-surface"></div>
                            </div>
                            <div class="glass-stem"></div>
                            <div class="glass-base"></div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="waterCount">0</div>
                                <div class="stat-label">Glasses</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="streakCount">0</div>
                                <div class="stat-label">Day Streak</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="goalPercent">0%</div>
                                <div class="stat-label">Daily Goal</div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

            <!-- Badges Container -->
            <div class="badges-container" id="dashboardBadges">
                <div class="empty-badges" id="emptyBadges">
                    <i class="fas fa-trophy"></i>
                    <p>No badges earned yet</p>
                    <p style="font-size: 12px; margin-top: 5px;">Keep drinking water to earn badges!</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="app-footer">
                <p>Stay hydrated for better Health and Productivity ❤️ | © 2025 </p>
            </div>
            </div> <!-- This closes the dashboard-page -->

            <!-- History Page -->
            <div class="content-section" id="history-page">
                <div class="content-header">
                    <h2>Drinking History</h2>
                    <p>Track your water consumption over time</p>
                </div>

                <div class="card full-width">
                    <div class="card-header">
                        <i class="fas fa-history"></i>
                        <h3>Recent Activity</h3>
                        <div class="history-buttons">
                            <button id="exportHistoryBtn" class="btn btn-primary">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button id="clearHistoryBtn" class="btn btn-secondary">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="history-list" id="history-list">
                        <div class="empty-history" id="emptyHistory">
                            <i class="fas fa-history"></i>
                            <p>No drinking history yet</p>
                            <p style="font-size: 12px; margin-top: 5px;">Your drinking sessions will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Page -->
            <div class="content-section" id="statistics-page">
                <div class="content-header">
                    <h2>Statistics</h2>
                    <p>View your hydration patterns and progress</p>
                </div>

                <div class="cards-container">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-calendar-week"></i>
                            <h3>Weekly Progress</h3>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="weekGlasses">0</div>
                                <div class="stat-label">This Week</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="avgDaily">0</div>
                                <div class="stat-label">Avg Daily</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="completionRate">0%</div>
                                <div class="stat-label">Goal Rate</div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i>
                            <h3>Monthly Trends</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                        <div class="stats-export-buttons">
                            <button id="exportStatsTxt" class="btn btn-primary">
                                <i class="fas fa-file-alt"></i> Export TXT
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements Page -->
            <div class="content-section" id="achievements-page">
                <div class="content-header">
                    <h2>Achievements</h2>
                    <p>Unlock badges and rewards for your hydration journey</p>
                </div>

                <div class="cards-container">
                    <div class="card full-width">
                        <div class="card-header">
                            <i class="fas fa-trophy"></i>
                            <h3>Your Achievements</h3>
                            <div class="stat-value" id="achievementCount">0/12</div>
                        </div>
                        <div id="achievementsList" style="padding: 10px 0;">
                            <!-- Achievements will be added dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="content-section" id="settings-page">
                <div class="content-header">
                    <h2>Settings</h2>
                    <p>Customize your water reminder experience</p>
                </div>

                <div class="card full-width">
                    <div class="card-header">
                        <i class="fas fa-sliders-h"></i>
                        <h3>Reminder Settings</h3>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Your Name</label>
                        <input type="text" id="userName" class="setting-input" placeholder="Enter your name" required>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Reminder Interval</label>
                        <div class="inline-input">
                            <input type="number" id="intervalMinutes" class="setting-input" min="1" max="180" value="60">
                            <span>minutes</span>
                            <button id="setIntervalBtn" class="btn btn-primary">Apply</button>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Daily Water Goal</label>
                        <div class="inline-input">
                            <input type="number" id="dailyGoal" class="setting-input" min="1" max="24" value="12">
                            <span>glasses</span>
                            <button id="setGoalBtn" class="btn btn-primary">Set Goal</button>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Notification Sound</label>
                        <div class="sound-options">
                            <div class="sound-option selected" data-sound="chime">
                                <i class="fas fa-bell"></i>
                                <div>Chime</div>
                            </div>
                            <div class="sound-option" data-sound="water">
                                <i class="fas fa-tint"></i>
                                <div>Water Drop</div>
                            </div>
                            <div class="sound-option" data-sound="gentle">
                                <i class="fas fa-volume-up"></i>
                                <div>Gentle Tone</div>
                            </div>
                            <div class="sound-option" data-sound="none">
                                <i class="fas fa-volume-mute"></i>
                                <div>No Sound</div>
                            </div>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Dark Mode</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Auto-start with system</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoStart">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Enable Desktop Notifications</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="desktopNotifications" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- About Page -->
            <div class="content-section" id="about-page">
                <div class="content-header">
                    <h2>About</h2>
                    <p>Learn more about your water reminder app</p>
                </div>

                <div class="about-content">
                    <div class="about-section">
                        <h3>What is Water Reminder?</h3>
                        <p>Water Reminder is a desktop application designed to help you maintain proper hydration throughout the day by sending regular reminders to drink water.</p>
                    </div>

                    <div class="about-section">
                        <h3>Why Stay Hydrated?</h3>
                        <p>Proper hydration is essential for maintaining bodily functions, improving the performance, and promoting overall health. The human body is about 60% water, and even mild dehydration can affect your mood, energy levels, and ability to think clearly.</p>
                    </div>

                    <div class="about-section">
                        <h3>Features</h3>
                        <p>
                            • Customizable reminder intervals<br>
                            • Daily water consumption tracking<br>
                            • Progress statistics and streaks<br>
                            • System tray integration<br>
                            • Auto-start with system<br>
                            • Beautiful, User-friendly interface
                        </p>
                    </div>

                    <div class="about-section">
                        <h3>Credits</h3>
                        <p>
                            Developed by <a href="https://github.com/AnukarOP" target="_blank">Anukar</a><br>
                            Built with <3
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Small Screen Warning -->
    <div id="smallScreenWarning" class="small-screen-warning">
        <i class="fas fa-expand-alt"></i>
        <h2>Suggestion</h2>
        <p>For the best experience, open the App in full  window.</p>
        <button id="continueBtn" class="btn btn-primary">Sure</button>
    </div>

    <script>
        // Water Reminder App - Enhanced with Background Timer Fix
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const countdown = document.getElementById('countdown');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const intervalMinutes = document.getElementById('intervalMinutes');
            const setIntervalBtn = document.getElementById('setIntervalBtn');
            const dailyGoal = document.getElementById('dailyGoal');
            const setGoalBtn = document.getElementById('setGoalBtn');
            const autoStart = document.getElementById('autoStart');
            const desktopNotifications = document.getElementById('desktopNotifications');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const themeToggleBtn = document.getElementById('themeToggle');
            const waterCount = document.getElementById('waterCount');
            const streakCount = document.getElementById('streakCount');
            const goalPercent = document.getElementById('goalPercent');
            const progressBar = document.getElementById('progressBar');
            const waterFill = document.getElementById('waterFill');
            const historyList = document.getElementById('history-list');
            const emptyHistory = document.getElementById('emptyHistory');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const exportHistoryBtn = document.getElementById('exportHistoryBtn');
            const weekGlasses = document.getElementById('weekGlasses');
            const avgDaily = document.getElementById('avgDaily');
            const completionRate = document.getElementById('completionRate');
            const achievementsList = document.getElementById('achievementsList');
            const achievementCount = document.getElementById('achievementCount');
            const exportStatsTxt = document.getElementById('exportStatsTxt');
            const navItems = document.querySelectorAll('.nav-item');
            const contentSections = document.querySelectorAll('.content-section');
            const smallScreenWarning = document.getElementById('smallScreenWarning');
            const continueBtn = document.getElementById('continueBtn');
            const greeting = document.getElementById('greeting');
            const userName = document.getElementById('userName');
            const soundOptions = document.querySelectorAll('.sound-option');
            const particlesContainer = document.getElementById('particlesContainer');
            const celebration = document.getElementById('celebration');
            const dashboardBadges = document.getElementById('dashboardBadges');
            const emptyBadges = document.getElementById('emptyBadges');

            // Audio Context for Sounds
            let audioContext = null;
            
            // App State - UPDATED with background timer fix
            let appState = {
                timerInterval: null,
                remainingTime: 60 * 60, // 60 minutes in seconds
                isRunning: false,
                interval: 60, // Default interval in minutes
                waterConsumed: 0,
                currentStreak: 0,
                dailyWaterGoal: 12,
                drinkingHistory: [],
                achievements: [],
                achievementCounts: {},
                weeklyStats: {
                    totalGlasses: 0,
                    daysCompleted: 0
                },
                userName: '',
                desktopNotifications: true,
                darkMode: true,
                notificationSound: 'chime',
                currentNotification: null,
                notificationTimeout: null,
                charts: {},
                // NEW: Date-based timer properties for background functionality
                timerStartTime: null, // When the timer was started
                timerEndTime: null,   // When the timer should end
                lastUpdateTime: null, // Last time we updated the timer
                backgroundCheckInterval: null, // Interval for background checks
                lastDrinkDate: null,
                lastCheckedDate: null // ← ADD THIS LINE HERE TOO
            };

            // Enhanced Achievements List with counting capability
            const allAchievements = [
                {
                    id: 'first_drink',
                    name: 'First Sip',
                    description: 'Drank your first glass of water',
                    icon: 'fas fa-tint',
                    color: '#2c80ff',
                    condition: (state) => state.waterConsumed >= 1,
                    maxCount: 1 // Can only earn once
                },
                {
                    id: 'daily_goal',
                    name: 'Daily Champion',
                    description: 'Reached your daily water goal',
                    icon: 'fas fa-bullseye',
                    color: '#48bb78',
                    condition: (state) => state.waterConsumed >= state.dailyWaterGoal,
                    maxCount: null // Can earn multiple times
                },
                {
                    id: 'three_day_streak',
                    name: 'Consistent Hydrator',
                    description: '3-day drinking streak',
                    icon: 'fas fa-fire',
                    color: '#ed8936',
                    condition: (state) => state.currentStreak >= 3,
                    maxCount: 1
                },
                {
                    id: 'seven_day_streak',
                    name: 'Weekly Warrior',
                    description: '7-day drinking streak',
                    icon: 'fas fa-medal',
                    color: 'gold',
                    condition: (state) => state.currentStreak >= 7,
                    maxCount: 1
                },
                {
                    id: 'thirty_day_streak',
                    name: 'Hydration Master',
                    description: '30-day drinking streak',
                    icon: 'fas fa-crown',
                    color: '#ffd700',
                    condition: (state) => state.currentStreak >= 30,
                    maxCount: 1
                },
                {
                    id: 'fifty_glasses',
                    name: 'Half Century',
                    description: 'Drank 50 glasses total',
                    icon: 'fas fa-wine-bottle',
                    color: '#9f7aea',
                    condition: (state) => state.drinkingHistory.length >= 50,
                    maxCount: 1
                },
                {
                    id: 'hundred_glasses',
                    name: 'Century Club',
                    description: 'Drank 100 glasses total',
                    icon: 'fas fa-award',
                    color: '#e53e3e',
                    condition: (state) => state.drinkingHistory.length >= 100,
                    maxCount: 1
                },
                {
                    id: 'early_bird',
                    name: 'Early Bird',
                    description: 'Drank water before 8 AM',
                    icon: 'fas fa-sun',
                    color: '#f6e05e',
                    condition: (state) => {
                        const earlyDrinks = state.drinkingHistory.filter(session => {
                            const hour = new Date(session.timestamp).getHours();
                            return hour < 8;
                        });
                        return earlyDrinks.length > 0;
                    },
                    maxCount: null // Can earn multiple times
                },
                {
                    id: 'night_owl',
                    name: 'Night Owl',
                    description: 'Drank water after 10 PM',
                    icon: 'fas fa-moon',
                    color: '#4a5568',
                    condition: (state) => {
                        const lateDrinks = state.drinkingHistory.filter(session => {
                            const hour = new Date(session.timestamp).getHours();
                            return hour >= 22;
                        });
                        return lateDrinks.length > 0;
                    },
                    maxCount: null
                },
                {
                    id: 'perfect_week',
                    name: 'Perfect Week',
                    description: 'Completed daily goal for 7 days straight',
                    icon: 'fas fa-star',
                    color: '#ff6b6b',
                    condition: (state) => state.weeklyStats.daysCompleted >= 7,
                    maxCount: null
                },
                {
                    id: 'speed_drinker',
                    name: 'Speed Drinker',
                    description: 'Drank 5 glasses in one day',
                    icon: 'fas fa-bolt',
                    color: '#68d391',
                    condition: (state) => {
                        const today = new Date().toDateString();
                        const todayDrinks = state.drinkingHistory.filter(session => 
                            new Date(session.timestamp).toDateString() === today
                        );
                        return todayDrinks.length >= 5;
                    },
                    maxCount: null
                },
                {
                    id: 'weekend_warrior',
                    name: 'Weekend Warrior',
                    description: 'Reached goal on both weekend days',
                    icon: 'fas fa-umbrella-beach',
                    color: '#63b3ed',
                    condition: (state) => {
                        // This would require more complex tracking
                        return state.currentStreak >= 2;
                    },
                    maxCount: null
                }
            ];

            // Initialize the app
            function initializeApp() {
                loadFromStorage();
                checkForMissedNotifications(); // NEW: Check if we missed any notifications
                checkNewDay();
                updateUI();
                updateStatistics();
                updateAchievements();
                updateDashboardBadges();
                checkScreenSize();
                applyDarkMode();
                initializeCharts();
                createParticles();
                
                // Auto-start if enabled
                if (appState.autoStart) {
                    setTimeout(() => {
                        startTimer();
                    }, 100);
                }
                
                // Request notification permission
                if (Notification.permission === 'default') {
                    Notification.requestPermission();
                }

                // NEW: Set up background check interval
                appState.backgroundCheckInterval = setInterval(checkBackgroundTimer, 1000);
                
                // Set up visibility change listener
                document.addEventListener('visibilitychange', handleVisibilityChange);
            }

            // NEW: Check for missed notifications when app starts
            function checkForMissedNotifications() {
                if (!appState.isRunning || !appState.timerEndTime) return;
                
                const now = Date.now();
                if (now >= appState.timerEndTime) {
                    // Timer has expired while app was closed
                    appState.isRunning = false;
                    appState.remainingTime = 0;
                    
                    // Show notification immediately
                    showDesktopNotification();
                    
                    // Reset timer state
                    appState.timerStartTime = null;
                    appState.timerEndTime = null;
                }
            }
            // NEW: Check if it's a new day and reset daily progress
            function checkNewDay() {
                const today = new Date().toDateString();
                
                if (appState.lastCheckedDate !== today) {
                    // It's a new day!
                    appState.lastCheckedDate = today;
                    
                    // Reset daily progress in UI
                    updateUI();
                    
                    safeSaveToStorage();
                }
            }

            // Call this periodically (every minute) to check for new day
            setInterval(checkNewDay, 60000);

            // NEW: Background timer check that works even when app is inactive
            function checkBackgroundTimer() {
                if (!appState.isRunning || !appState.timerEndTime) return;
                
                const now = Date.now();
                const timeRemaining = Math.max(0, Math.floor((appState.timerEndTime - now) / 1000));
                
                // Update the displayed time
                if (timeRemaining !== appState.remainingTime) {
                    appState.remainingTime = timeRemaining;
                    updateCountdown();
                    
                    // Check if timer has completed
                    if (timeRemaining <= 0) {
                        handleTimerCompletion();
                    }
                    
                    // Save state periodically
                    if (now - (appState.lastUpdateTime || 0) > 5000) { // Every 5 seconds
                        safeSaveToStorage();
                        appState.lastUpdateTime = now;
                    }
                }
            }

            // UPDATED: Handle timer completion
            function handleTimerCompletion() {
                // Clear any existing interval
                if (appState.timerInterval) {
                    clearInterval(appState.timerInterval);
                    appState.timerInterval = null;
                }
                
                // Reset timer state
                appState.isRunning = false;
                appState.remainingTime = 0;
                appState.timerStartTime = null;
                appState.timerEndTime = null;
                
                // Reset UI state
                startBtn.style.display = 'flex';
                stopBtn.style.display = 'none';
                updateCountdown();
                
                // Show notification
                if (!appState.preventDuplicateNotification) {
                    showDesktopNotification();
                }
                appState.preventDuplicateNotification = false;
                
                safeSaveToStorage();
            }

            // UPDATED: Handle visibility change
            function handleVisibilityChange() {
                if (document.hidden) {
                    // App going to background - save current state
                    safeSaveToStorage();
                } else {
                    // App coming to foreground - update timer immediately
                    checkBackgroundTimer();
                }
            }

            // Create floating particles
            function createParticles() {
                for (let i = 0; i < 15; i++) {
                    createParticle();
                }
            }

            function createParticle() {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Random position
                const left = Math.random() * 100;
                const delay = Math.random() * 5;
                
                particle.style.left = `${left}%`;
                particle.style.animationDelay = `${delay}s`;
                
                // Random size and opacity
                const size = 4 + Math.random() * 6;
                const opacity = 0.3 + Math.random() * 0.4;
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.opacity = opacity;
                
                particlesContainer.appendChild(particle);
                
                // Remove particle after animation and create new one
                setTimeout(() => {
                    particle.remove();
                    createParticle();
                }, 6000);
            }

            // Initialize charts
            function initializeCharts() {
                // Weekly Chart
                const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
                appState.charts.weekly = new Chart(weeklyCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Glasses per Day',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(44, 128, 255, 0.6)',
                            borderColor: 'rgba(44, 128, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });

                // Monthly Chart
                const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
                appState.charts.monthly = new Chart(monthlyCtx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 30}, (_, i) => i + 1),
                        datasets: [{
                            label: 'Daily Glasses',
                            data: Array(30).fill(0),
                            borderColor: 'rgba(44, 128, 255, 1)',
                            backgroundColor: 'rgba(44, 128, 255, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Update charts with real data
            function updateCharts() {
                // Update weekly chart
                const weekData = getWeeklyData();
                appState.charts.weekly.data.datasets[0].data = weekData;
                appState.charts.weekly.update();

                // Update monthly chart
                const monthData = getMonthlyData();
                appState.charts.monthly.data.datasets[0].data = monthData;
                appState.charts.monthly.update();
            }

            function getWeeklyData() {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const result = [0, 0, 0, 0, 0, 0, 0];
                
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                appState.drinkingHistory.forEach(session => {
                    const date = new Date(session.timestamp);
                    if (date >= oneWeekAgo) {
                        const dayIndex = date.getDay();
                        result[dayIndex] += 1;
                    }
                });
                
                // Reorder to start from Monday
                return [...result.slice(1), result[0]];
            }

            function getMonthlyData() {
                const result = Array(30).fill(0);
                const today = new Date();
                
                appState.drinkingHistory.forEach(session => {
                    const date = new Date(session.timestamp);
                    const dayDiff = Math.floor((today - date) / (1000 * 60 * 60 * 24));
                    if (dayDiff < 30) {
                        result[29 - dayDiff] += 1;
                    }
                });
                
                return result;
            }

            // Play notification sound
            function playNotificationSound() {
                if (appState.notificationSound === 'none') return;
                
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Different sounds based on selection
                switch(appState.notificationSound) {
                    case 'chime':
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(784, audioContext.currentTime); // G5
                        oscillator.frequency.setValueAtTime(1047, audioContext.currentTime + 0.2); // C6
                        break;
                    case 'water':
                        oscillator.type = 'sine';
                        for(let i = 0; i < 3; i++) {
                            oscillator.frequency.setValueAtTime(523 + i*100, audioContext.currentTime + i*0.1); // C5
                        }
                        break;
                    case 'gentle':
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
                        break;
                }

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            }

            // Celebration animation
            function showCelebration() {
                celebration.style.display = 'block';
                
                // Create confetti
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    
                    // Random color
                    const colors = ['#2c80ff', '#48bb78', '#ed8936', '#9f7aea', '#e53e3e'];
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.background = color;
                    
                    // Random position and animation
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.animationDelay = `${Math.random() * 2}s`;
                    
                    celebration.appendChild(confetti);
                    
                    // Remove confetti after animation
                    setTimeout(() => {
                        confetti.remove();
                    }, 3000);
                }
                
                // Hide celebration after 3 seconds
                setTimeout(() => {
                    celebration.style.display = 'none';
                    celebration.innerHTML = '';
                }, 3000);
            }

            // Export data functions
            function exportHistoryToTxt() {
                let content = 'Water Reminder - Drinking History\n';
                content += 'Generated on: ' + new Date().toLocaleString() + '\n\n';
                
                if (appState.drinkingHistory.length === 0) {
                    content += 'No drinking history available.';
                } else {
                    content += 'Date\t\tTime\t\tGlasses\n';
                    content += '----------------------------------------\n';
                    
                    appState.drinkingHistory.forEach(session => {
                        const date = new Date(session.timestamp);
                        const dateStr = date.toLocaleDateString();
                        const timeStr = date.toLocaleTimeString();
                        content += `${dateStr}\t${timeStr}\t1\n`;
                    });
                }
                
                downloadFile(content, 'water_history.txt', 'text/plain');
            }

            function exportStatisticsToTxt() {
                let content = 'Water Reminder - Statistics Report\n';
                content += 'Generated on: ' + new Date().toLocaleString() + '\n\n';
                
                content += 'OVERVIEW:\n';
                content += `Total Glasses: ${appState.drinkingHistory.length}\n`;
                content += `Current Streak: ${appState.currentStreak} days\n`;
                content += `Daily Goal: ${appState.dailyWaterGoal} glasses\n`;
                content += `Today's Progress: ${appState.waterConsumed}/${appState.dailyWaterGoal}\n\n`;
                
                content += 'WEEKLY SUMMARY:\n';
                const weekData = getWeeklyData();
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                days.forEach((day, index) => {
                    content += `${day}: ${weekData[index]} glasses\n`;
                });
                
                downloadFile(content, 'water_statistics.txt', 'text/plain');
            }

            function downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // UPDATED: Load from storage with timer restoration
            function loadFromStorage() {
                try {
                    const savedData = localStorage.getItem('hydroPalData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        
                        // Load basic properties
                        appState.interval = data.interval || 60;
                        appState.waterConsumed = data.waterConsumed || 0;
                        appState.currentStreak = data.currentStreak || 0;
                        appState.dailyWaterGoal = data.dailyWaterGoal || 12;
                        appState.drinkingHistory = data.drinkingHistory || [];
                        appState.achievements = data.achievements || [];
                        appState.achievementCounts = data.achievementCounts || {};
                        appState.weeklyStats = data.weeklyStats || { totalGlasses: 0, daysCompleted: 0 };
                        appState.userName = data.userName || '';
                        appState.desktopNotifications = data.desktopNotifications !== undefined ? data.desktopNotifications : true;
                        appState.darkMode = data.darkMode || false;
                        appState.notificationSound = data.notificationSound || 'chime';
                        appState.lastDrinkDate = data.lastDrinkDate || null;
                        appState.lastCheckedDate = data.lastCheckedDate || null; // ← ADD THIS LINE
                        
                        // NEW: Load timer state and restore if needed
                        if (data.isRunning && data.timerEndTime) {
                            const now = Date.now();
                            const timeRemaining = Math.max(0, Math.floor((data.timerEndTime - now) / 1000));
                            
                            if (timeRemaining > 0) {
                                // Timer is still running
                                appState.isRunning = true;
                                appState.timerEndTime = data.timerEndTime;
                                appState.remainingTime = timeRemaining;
                                
                                // Update UI to show running state
                                startBtn.style.display = 'none';
                                stopBtn.style.display = 'flex';
                            } else {
                                // Timer has expired
                                appState.isRunning = false;
                                appState.remainingTime = 0;
                                appState.timerEndTime = null;
                                
                                // Show notification if needed
                                if (data.timerEndTime && now - data.timerEndTime < 60000) { // Within 1 minute of expiration
                                    setTimeout(() => {
                                        showDesktopNotification();
                                    }, 1000);
                                }
                            }
                        } else {
                            appState.isRunning = false;
                            appState.remainingTime = appState.interval * 60;
                        }
                    }
                    
                    // Set UI values
                    intervalMinutes.value = appState.interval;
                    dailyGoal.value = appState.dailyWaterGoal;
                    autoStart.checked = appState.autoStart || false;
                    desktopNotifications.checked = appState.desktopNotifications !== false;
                    darkModeToggle.checked = appState.darkMode || false;
                    userName.value = appState.userName || '';
                    
                    // Set sound selection
                    soundOptions.forEach(option => {
                        option.classList.remove('selected');
                        if (option.dataset.sound === appState.notificationSound) {
                            option.classList.add('selected');
                        }
                    });
                    
                    updateGreeting();
                    updateCountdown();
                    
                } catch (error) {
                    console.error('Error loading from storage:', error);
                    // Reset to defaults on error
                    resetAppState();
                }
            }

            // Helper function to reset app state
            function resetAppState() {
                appState = {
                    timerInterval: null,
                    remainingTime: 60 * 60,
                    isRunning: false,
                    interval: 60,
                    waterConsumed: 0,
                    currentStreak: 0,
                    dailyWaterGoal: 8,
                    drinkingHistory: [],
                    achievements: [],
                    achievementCounts: {},
                    weeklyStats: {
                        totalGlasses: 0,
                        daysCompleted: 0
                    },
                    userName: '',
                    desktopNotifications: true,
                    darkMode: false,
                    notificationSound: 'chime',
                    currentNotification: null,
                    notificationTimeout: null,
                    charts: {},
                    timerStartTime: null,
                    timerEndTime: null,
                    lastUpdateTime: null,
                    backgroundCheckInterval: null,
                    lastDrinkDate: null,
                    lastCheckedDate: null // ← ADD THIS LINE
                };
                
                // Reset UI
                intervalMinutes.value = appState.interval;
                dailyGoal.value = appState.dailyWaterGoal;
                updateUI();
            }

            // UPDATED: Save to storage with timer state
            function saveToStorage() {
                try {
                    // Create a clean copy of appState without circular references
                    const storageData = {
                        timerInterval: null, // Don't save interval reference
                        remainingTime: appState.remainingTime,
                        isRunning: appState.isRunning,
                        interval: appState.interval,
                        waterConsumed: appState.waterConsumed,
                        currentStreak: appState.currentStreak,
                        dailyWaterGoal: appState.dailyWaterGoal,
                        drinkingHistory: appState.drinkingHistory,
                        achievements: appState.achievements,
                        achievementCounts: appState.achievementCounts,
                        weeklyStats: appState.weeklyStats,
                        userName: appState.userName,
                        desktopNotifications: appState.desktopNotifications,
                        darkMode: appState.darkMode,
                        notificationSound: appState.notificationSound,
                        currentNotification: null, // Don't save notification object
                        notificationTimeout: null, // Don't save timeout reference
                        charts: {}, // Don't save chart objects
                        timerStartTime: appState.timerStartTime,
                        timerEndTime: appState.timerEndTime, // NEW: Save end time
                        lastUpdateTime: appState.lastUpdateTime,
                        lastCheckedDate: appState.lastCheckedDate,
                        backgroundCheckInterval: null, // Don't save interval
                        lastDrinkDate: appState.lastDrinkDate
                    };

                    localStorage.setItem('hydroPalData', JSON.stringify(storageData));
                    console.log('Data saved successfully');
                } catch (error) {
                    console.error('Error saving to storage:', error);
                    // Fallback: try to save only essential data
                    const essentialData = {
                        remainingTime: appState.remainingTime,
                        isRunning: appState.isRunning,
                        interval: appState.interval,
                        waterConsumed: appState.waterConsumed,
                        currentStreak: appState.currentStreak,
                        dailyWaterGoal: appState.dailyWaterGoal,
                        drinkingHistory: appState.drinkingHistory,
                        achievements: appState.achievements,
                        achievementCounts: appState.achievementCounts,
                        userName: appState.userName,
                        desktopNotifications: appState.desktopNotifications,
                        darkMode: appState.darkMode,
                        notificationSound: appState.notificationSound,
                        timerEndTime: appState.timerEndTime // NEW: Essential for background timer
                    };
                    localStorage.setItem('hydroPalData', JSON.stringify(essentialData));
                }
            }

            // Apply dark mode
            function applyDarkMode() {
                if (appState.darkMode) {
                    document.body.classList.add('dark-mode');
                    themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
                } else {
                    document.body.classList.remove('dark-mode');
                    themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i><span>Dark Mode</span>';
                }
            }

            // Update greeting with user name
            function updateGreeting() {
                if (appState.userName) {
                    greeting.innerHTML = `Hello, ${appState.userName} 👋<br><span style="font-size: 18px; color: var(--text-light);">Stay Hydrated</span>`;
                } else {
                    greeting.innerHTML = 'Stay Hydrated';
                }
            }

            // Update all UI elements
            function updateUI() {
                updateCountdown();
                updateStats();
                updateHistory();
                updateProgressBar();
                updateWaterGlass();
            }

            // Update countdown display
            function updateCountdown() {
                const hours = Math.floor(appState.remainingTime / 3600);
                const minutes = Math.floor((appState.remainingTime % 3600) / 60);
                const seconds = appState.remainingTime % 60;
                
                countdown.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // UPDATED: Update water glass visualization - Only today's progress
            function updateWaterGlass() {
                const todayGlasses = getTodayGlasses();
                const percent = Math.min(100, (todayGlasses / appState.dailyWaterGoal) * 100);
                waterFill.style.height = `${percent}%`;
            }

            // Add this safety function
            function safeSaveToStorage() {
                try {
                    saveToStorage();
                } catch (error) {
                    console.error('Failed to save to storage:', error);
                    // Continue without saving - don't break the timer
                }
            }

            // UPDATED: Start timer with date-based approach
            function startTimer() {
                // Clear any existing timer first
                if (appState.timerInterval) {
                    clearInterval(appState.timerInterval);
                    appState.timerInterval = null;
                }
                
                if (appState.isRunning) return;
                
                appState.isRunning = true;
                startBtn.style.display = 'none';
                stopBtn.style.display = 'flex';
                
                // Reset the prevent duplicate flag
                appState.preventDuplicateNotification = false;
                
                // Calculate end time based on current time and interval
                const now = Date.now();
                appState.timerStartTime = now;
                appState.timerEndTime = now + (appState.interval * 60 * 1000);
                appState.remainingTime = appState.interval * 60;
                
                // Update countdown immediately
                updateCountdown();
                
                // Set up visual update interval (for smooth countdown)
                appState.timerInterval = setInterval(() => {
                    checkBackgroundTimer();
                }, 1000);
                
                // Notify Electron if available
                if (window.ipcRenderer && !appState.preventDuplicateNotification) {
                    window.ipcRenderer.send('start-timer');
                }
                
                safeSaveToStorage();
            }

            // UPDATED: Stop timer
            function stopTimer() {
                appState.isRunning = false;
                startBtn.style.display = 'flex';
                stopBtn.style.display = 'none';
                
                // Clear intervals
                if (appState.timerInterval) {
                    clearInterval(appState.timerInterval);
                    appState.timerInterval = null;
                }
                
                // Reset timer state
                appState.timerStartTime = null;
                appState.timerEndTime = null;
                appState.remainingTime = appState.interval * 60;
                
                // Update display
                updateCountdown();
                
                // Notify Electron if available
                if (window.ipcRenderer) {
                    window.ipcRenderer.send('stop-timer');
                }
                
                safeSaveToStorage();
            }

            // UPDATED: Reset timer
            function resetTimer() {
                // Clear any existing interval
                if (appState.timerInterval) {
                    clearInterval(appState.timerInterval);
                    appState.timerInterval = null;
                }
                
                // Reset state
                appState.isRunning = false;
                appState.remainingTime = appState.interval * 60;
                appState.preventDuplicateNotification = false;
                appState.timerStartTime = null;
                appState.timerEndTime = null;
                
                // Update UI
                startBtn.style.display = 'flex';
                stopBtn.style.display = 'none';
                updateCountdown();
                
                if (window.ipcRenderer) {
                    window.ipcRenderer.send('stop-timer');
                }
                
                safeSaveToStorage();
            }

            // Show desktop notification with action buttons
            function showDesktopNotification() {
                if (!appState.desktopNotifications) {
                    resetTimer();
                    return;
                }
                
                if (Notification.permission !== 'granted') {
                    resetTimer();
                    return;
                }
                
                const userNamePart = appState.userName ? `${appState.userName}, ` : '';
                
                try {
                    // Play sound
                    playNotificationSound();
                    
                    const notification = new Notification('Water Reminder - Time to Hydrate!', {
                        body: `${userNamePart}It's time to drink a glass of water. \n\nHit "Close" when you're done!✨`,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTMyIDhDNDEuOTU2NyA4IDUwIDE2LjA0MzMgNTAgMjZDNTAgMzUuOTU2NyA0MS45NTY3IDQ0IDMyIDQ0QzIyLjA0MzMgNDQgMTQgMzUuOTU2NyAxNCAyNkMxNCAxNi4wNDMzIDIyLjA0MzMgOCAzMiA4WiIgZmlsbD0iIzJjODBmZiIvPgo8cGF0aCBkPSJNMzIgMTZDMzcuNTIyOCAxNiA0MiAyMC40NzcyIDQyIDI2QzQyIDMxLjUyMjggMzcuNTIyOCAzNiAzMiAzNkMyNi40NzcyIDM2IDIyIDMxLjUyMjggMjIgMjZDMjIgMjAuNDc3MiAyNi40NzcyIDE2IDMyIDE2WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTI2IDU2QzI2IDU2IDI0IDU0IDI0IDUwQzI0IDQ2IDI2IDQ0IDI2IDQ0SDM4QzM4IDQ0IDQwIDQ2IDQwIDUwQzQwIDU0IDM4IDU2IDM4IDU2SDI2WiIgZmlsbD0iIzJjODBmZiIvPgo8L3N2Zz4K',
                        tag: 'hydration-reminder',
                        requireInteraction: true,
                    });
                    
                    appState.currentNotification = notification;
                    
                    notification.onclick = function() {
                        window.focus();
                        handleNotificationAction('done');
                    };
                    
                    appState.notificationTimeout = setTimeout(() => {
                        if (notification && !notification.closed) {
                            notification.close();
                            appState.currentNotification = null;
                            resetTimer();
                        }
                    }, 300000);
                    
                } catch (error) {
                    console.error('Error showing notification:', error);
                    resetTimer();
                }
            }

            // FIXED: Handle notification action
            function handleNotificationAction(action) {
                if (appState.notificationTimeout) {
                    clearTimeout(appState.notificationTimeout);
                    appState.notificationTimeout = null;
                }
                
                if (appState.currentNotification) {
                    appState.currentNotification.close();
                    appState.currentNotification = null;
                }
                
                // Clear any existing timer interval first
                if (appState.timerInterval) {
                    clearInterval(appState.timerInterval);
                    appState.timerInterval = null;
                }
                
                // In the handleNotificationAction function, update this part:
                if (action === 'done') {
                    // Add drinking session
                    addDrinkingSession();
                    
                    // Reset timer state completely
                    appState.isRunning = false;
                    appState.remainingTime = appState.interval * 60;
                    appState.timerStartTime = null;
                    appState.timerEndTime = null;
                    
                    // Update UI to show stopped state
                    startBtn.style.display = 'flex';
                    stopBtn.style.display = 'none';
                    updateCountdown();
                    
                    // Get today's count to check goal
                    const todayGlasses = getTodayGlasses();
                    
                    // Only restart timer if we haven't reached the daily goal
                    if (todayGlasses < appState.dailyWaterGoal) {
                        // Use a small delay to ensure clean state
                        setTimeout(() => {
                            startTimer();
                        }, 500);
                    } else {
                        // Goal reached - show celebration
                        if (appState.desktopNotifications && Notification.permission === 'granted') {
                            const userNamePart = appState.userName ? `${appState.userName}, ` : '';
                            new Notification('🎉 Daily Goal Achieved!', {
                                body: `${userNamePart}Congratulations! You've reached your daily water goal of ${appState.dailyWaterGoal} glasses.`,
                                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTMyIDhDNDEuOTU2NyA4IDUwIDE2LjA0MzMgNTAgMjZDNTAgMzUuOTU2NyA0MS45NTY3IDQ0IDMyIDQ0QzIyLjA0MzMgNDQgMTQgMzUuOTU2NyAxNCAyNkMxNCAxNi4wNDMzIDIyLjA0MzMgOCAzMiA4WiIgZmlsbD0iI2ZmNmI2YiIvPgo8cGF0aCBkPSJNMjYgMjZMMzAgMzBMMzggMjJMNCA1NloiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo='
                            });
                        }
                        showCelebration();
                    }
                } else {
                    // For other actions, just reset the timer completely
                    appState.isRunning = false;
                    appState.remainingTime = appState.interval * 60;
                    appState.timerStartTime = null;
                    appState.timerEndTime = null;
                    
                    startBtn.style.display = 'flex';
                    stopBtn.style.display = 'none';
                    updateCountdown();
                }
                
                safeSaveToStorage();
                
                if (window.ipcRenderer) {
                    window.ipcRenderer.send('reset-notifications');
                }
            }

            // UPDATED: Update stats display - Only today's progress
            function updateStats() {
                const todayGlasses = getTodayGlasses();
                waterCount.textContent = todayGlasses;
                streakCount.textContent = appState.currentStreak;
                
                const percent = Math.min(100, Math.round((todayGlasses / appState.dailyWaterGoal) * 100));
                goalPercent.textContent = `${percent}%`;
            }

            // NEW: Get today's glasses count
            function getTodayGlasses() {
                const today = new Date().toDateString();
                return appState.drinkingHistory.filter(session => {
                    const sessionDate = new Date(session.timestamp).toDateString();
                    return sessionDate === today;
                }).length;
            }

            // UPDATED: Update progress bar - Only today's progress
            function updateProgressBar() {
                const todayGlasses = getTodayGlasses();
                const percent = Math.min(100, (todayGlasses / appState.dailyWaterGoal) * 100);
                progressBar.style.width = `${percent}%`;
            }

            // Update drinking history
            function updateHistory() {
                historyList.innerHTML = '';
                
                if (appState.drinkingHistory.length === 0) {
                    historyList.appendChild(emptyHistory);
                    emptyHistory.style.display = 'block';
                    return;
                }
                
                emptyHistory.style.display = 'none';
                
                appState.drinkingHistory
                    .slice()
                    .reverse()
                    .forEach(entry => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        
                        const date = new Date(entry.timestamp);
                        const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const dateString = date.toLocaleDateString();
                        
                        historyItem.innerHTML = `
                            <div class="history-time">${timeString}</div>
                            <div class="history-date">${dateString}</div>
                        `;
                        
                        historyList.appendChild(historyItem);
                    });
            }

            // UPDATED: Add drinking session to history
            function addDrinkingSession() {
                const session = {
                    timestamp: new Date().toISOString(),
                    glasses: 1
                };
                
                appState.drinkingHistory.push(session);
                
                const todayGlasses = getTodayGlasses();
                const goalReached = todayGlasses >= appState.dailyWaterGoal;
                
                // Check for goal achievement
                if (goalReached) {
                    showCelebration();
                }
                
                updateStreak();
                updateStatistics();
                updateAchievements();
                updateCharts();
                
                safeSaveToStorage();
                updateUI();
                
                return goalReached;
            }

            // UPDATED: Update streak counter
            function updateStreak() {
                const today = new Date().toDateString();
                
                // If we already drank today, no need to update streak
                if (appState.lastDrinkDate === today) {
                    return;
                }
                
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayString = yesterday.toDateString();
                
                if (appState.lastDrinkDate === yesterdayString) {
                    // Continued streak - drank yesterday
                    appState.currentStreak++;
                } else if (appState.lastDrinkDate && appState.lastDrinkDate !== today) {
                    // Broken streak - missed a day
                    appState.currentStreak = 1;
                } else {
                    // First time or same day
                    appState.currentStreak = appState.currentStreak || 1;
                }
                
                appState.lastDrinkDate = today;
            }

            // Update statistics
            function updateStatistics() {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                const weekSessions = appState.drinkingHistory.filter(session => 
                    new Date(session.timestamp) >= oneWeekAgo
                );
                
                appState.weeklyStats.totalGlasses = weekSessions.length;
                appState.weeklyStats.daysCompleted = new Set(
                    weekSessions.map(session => new Date(session.timestamp).toDateString())
                ).size;
                
                weekGlasses.textContent = appState.weeklyStats.totalGlasses;
                avgDaily.textContent = Math.round(appState.weeklyStats.totalGlasses / 7) || 0;
                
                const goalCompletion = Math.min(100, Math.round((appState.weeklyStats.totalGlasses / (appState.dailyWaterGoal * 7)) * 100));
                completionRate.textContent = `${goalCompletion}%`;
            }

            // Update achievements to track counts
            function updateAchievements() {
                const newAchievements = [];
                
                allAchievements.forEach(achievement => {
                    const currentCount = appState.achievementCounts[achievement.id] || 0;
                    
                    if (achievement.condition(appState)) {
                        // Check if we can earn more of this achievement
                        const canEarnMore = achievement.maxCount === null || currentCount < achievement.maxCount;
                        
                        if (canEarnMore) {
                            // Increment count
                            appState.achievementCounts[achievement.id] = currentCount + 1;
                            
                            // Add to achievements array for backward compatibility (first time only)
                            if (!appState.achievements.includes(achievement.id)) {
                                appState.achievements.push(achievement.id);
                                newAchievements.push(achievement);
                            }
                        }
                    }
                });
                
                updateAchievementsUI();
                updateDashboardBadges();
                
                if (newAchievements.length > 0) {
                    showAchievementNotification(newAchievements[0]);
                }
            }

            // Update dashboard badges display
            function updateDashboardBadges() {
                dashboardBadges.innerHTML = '';
                
                // Get earned badges with counts
                const earnedBadges = allAchievements.filter(achievement => {
                    const count = appState.achievementCounts[achievement.id] || 0;
                    return count > 0;
                });
                
                if (earnedBadges.length === 0) {
                    dashboardBadges.appendChild(emptyBadges);
                    emptyBadges.style.display = 'block';
                    return;
                }
                
                emptyBadges.style.display = 'none';
                
                // Display up to 6 badges
                const badgesToShow = earnedBadges.slice(0, 6);
                
                badgesToShow.forEach(achievement => {
                    const count = appState.achievementCounts[achievement.id] || 0;
                    
                    const badgeEl = document.createElement('div');
                    badgeEl.className = `badge-item earned`;
                    badgeEl.innerHTML = `
                        <div class="badge-icon">
                            <i class="${achievement.icon}"></i>
                        </div>
                        ${count > 1 ? `<div class="badge-count">${count}</div>` : ''}
                        <div class="badge-name">${achievement.name}</div>
                    `;
                    
                    // Set custom gradient based on achievement color
                    badgeEl.style.background = `linear-gradient(135deg, ${achievement.color} 0%, ${darkenColor(achievement.color, 20)} 100%)`;
                    
                    dashboardBadges.appendChild(badgeEl);
                });
                
                // Show count if more than 6 badges
                if (earnedBadges.length > 6) {
                    const moreBadges = document.createElement('div');
                    moreBadges.className = 'badge-item';
                    moreBadges.innerHTML = `
                        <div class="badge-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="badge-count">+${earnedBadges.length - 6}</div>
                        <div class="badge-name">More Badges</div>
                    `;
                    moreBadges.onclick = () => {
                        // Navigate to achievements page
                        document.querySelector('[data-page="achievements"]').click();
                    };
                    dashboardBadges.appendChild(moreBadges);
                }
            }

            // Helper function to darken colors for gradients
            function darkenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                        (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            }

            // Update achievements UI to show counts
            function updateAchievementsUI() {
                achievementsList.innerHTML = '';
                
                const earnedCount = Object.keys(appState.achievementCounts).length;
                achievementCount.textContent = `${earnedCount}/${allAchievements.length}`;
                
                if (earnedCount === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'empty-history';
                    emptyMsg.style.padding = '20px';
                    emptyMsg.innerHTML = `
                        <i class="fas fa-trophy"></i>
                        <p>No achievements yet</p>
                        <p style="font-size: 12px; margin-top: 5px;">Keep drinking water to unlock achievements!</p>
                    `;
                    achievementsList.appendChild(emptyMsg);
                    return;
                }
                
                allAchievements.forEach(achievement => {
                    const count = appState.achievementCounts[achievement.id] || 0;
                    const earned = count > 0;
                    
                    const achievementEl = document.createElement('div');
                    achievementEl.className = `achievement-card ${earned ? 'earned' : ''}`;
                    
                    achievementEl.innerHTML = `
                        <div class="achievement-icon">
                            <i class="${achievement.icon}" style="color: ${achievement.color};"></i>
                        </div>
                        <div class="achievement-info">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-description">${achievement.description}</div>
                            ${earned ? `<div class="achievement-count">Earned ${count} time${count > 1 ? 's' : ''}</div>` : ''}
                        </div>
                        ${earned ? 
                            `<div class="achievement-badge">
                                ${count > 1 ? `<span class="badge-count-small">${count}</span>` : ''}
                                EARNED
                            </div>` : 
                            '<div style="color: var(--text-light); font-size: 12px;">Locked</div>'
                        }
                    `;
                    
                    achievementsList.appendChild(achievementEl);
                });
            }

            // Show achievement notification
            function showAchievementNotification(achievement) {
                if (appState.desktopNotifications && Notification.permission === 'granted') {
                    new Notification('🎉 Achievement Unlocked!', {
                        body: `${achievement.name}: ${achievement.description}`,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTMyIDhDNDEuOTU2NyA4IDUwIDE2LjA0MzMgNTAgMjZDNTAgMzUuOTU2NyA0MS45NTY3IDQ0IDMyIDQ0QzIyLjA0MzMgNDQgMTQgMzUuOTU2NyAxNCAyNkMxNCAxNi4wNDMzIDIyLjA0MzMgOCAzMiA4WiIgZmlsbD0iI2ZmNmI2YiIvPgo8cGF0aCBkPSJNMjYgMjZMMzAgMzBMMzggMjJMNCA1NloiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo='
                    });
                }
                
                // Show celebration for major achievements
                if (['seven_day_streak', 'thirty_day_streak', 'hundred_glasses'].includes(achievement.id)) {
                    showCelebration();
                }
            }

            // Check screen size and show warning if too small
            function checkScreenSize() {
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                if (width < 800 || height < 600) {
                    smallScreenWarning.classList.add('show');
                }
            }

            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page');
                    
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    contentSections.forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(`${pageId}-page`).classList.add('active');
                    
                    if (pageId === 'statistics') {
                        updateStatistics();
                        updateCharts();
                    } else if (pageId === 'achievements') {
                        updateAchievements();
                    }
                });
            });

            // Event Listeners
            startBtn.addEventListener('click', startTimer);
            stopBtn.addEventListener('click', stopTimer);
            
            setIntervalBtn.addEventListener('click', function() {
                const newInterval = parseInt(intervalMinutes.value);
                
                if (newInterval >= 1 && newInterval <= 180) {
                    appState.interval = newInterval;
                    appState.remainingTime = newInterval * 60;
                    
                    if (window.ipcRenderer) {
                        window.ipcRenderer.send('set-timer-duration', newInterval);
                    }
                    
                    if (appState.isRunning) {
                        resetTimer();
                        startTimer();
                    } else {
                        resetTimer();
                    }
                    safeSaveToStorage();
                } else {
                    alert('Please enter a value between 1 and 180 minutes.');
                }
            });
            
            setGoalBtn.addEventListener('click', function() {
                const newGoal = parseInt(dailyGoal.value);
                
                if (newGoal >= 1 && newGoal <= 24) {
                    appState.dailyWaterGoal = newGoal;
                    updateUI();
                    safeSaveToStorage();
                } else {
                    alert('Please enter a value between 1 and 24 glasses.');
                }
            });
            
            // Sound selection
            soundOptions.forEach(option => {
                option.addEventListener('click', function() {
                    soundOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    appState.notificationSound = this.dataset.sound;
                    safeSaveToStorage();

                    // Test sound
                    if (appState.notificationSound !== 'none') {
                        playNotificationSound();
                    }
                });
            });
            
            autoStart.addEventListener('change', function() {
                appState.autoStart = this.checked;
                safeSaveToStorage();
                
                if (window.ipcRenderer) {
                    window.ipcRenderer.send('toggle-auto-start', this.checked);
                }
            });
            
            desktopNotifications.addEventListener('change', function() {
                appState.desktopNotifications = this.checked;
                safeSaveToStorage();
                
                if (this.checked && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            });
            
            darkModeToggle.addEventListener('change', function() {
                appState.darkMode = this.checked;
                applyDarkMode();
                safeSaveToStorage();
            });
            
            themeToggleBtn.addEventListener('click', function() {
                appState.darkMode = !appState.darkMode;
                darkModeToggle.checked = appState.darkMode;
                applyDarkMode();
                safeSaveToStorage();
            });
            
            userName.addEventListener('change', function() {
                appState.userName = this.value;
                updateGreeting();
                safeSaveToStorage();
            });
            
            clearHistoryBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all drinking history?')) {
                    appState.drinkingHistory = [];
                    safeSaveToStorage();
                    updateHistory();
                    updateStatistics();
                    updateCharts();
                }
            });
            
            exportHistoryBtn.addEventListener('click', exportHistoryToTxt);
            exportStatsTxt.addEventListener('click', exportStatisticsToTxt);
            
            continueBtn.addEventListener('click', function() {
                smallScreenWarning.classList.remove('show');
            });
            
            window.addEventListener('resize', checkScreenSize);

            // Disable right-click context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });

            // Disable common keyboard shortcuts for copying/selecting
            document.addEventListener('keydown', function(e) {
                // Disable Ctrl+A (Select All)
                if (e.ctrlKey && e.key === 'a') {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+C (Copy)
                if (e.ctrlKey && e.key === 'c') {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+V (Paste) - except in input fields
                if (e.ctrlKey && e.key === 'v' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+X (Cut)
                if (e.ctrlKey && e.key === 'x') {
                    e.preventDefault();
                    return false;
                }

                 // Disable F12 (Developer Tools)
                if (e.key === 'F12') {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+Shift+I (Developer Tools)
                if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+U (View Source)
                if (e.ctrlKey && e.key === 'u') {
                    e.preventDefault();
                    return false;
                }
                
                // Disable Ctrl+Shift+C (Inspect Element)
                if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    return false;
                }
            });

            // Disable drag and drop
            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
                return false;
            });

            // Disable text selection on double click
            document.addEventListener('selectstart', function(e) {
                // Allow selection only in input fields
                if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                    e.preventDefault();
                    return false;
                }
            });

            // Disable mouse selection
            document.addEventListener('mousedown', function(e) {
                // Allow interaction with buttons and input fields
                if (!['INPUT', 'TEXTAREA', 'BUTTON'].includes(e.target.tagName) && 
                    !e.target.closest('.btn') && 
                    !e.target.closest('.nav-item') &&
                    !e.target.closest('.sound-option') &&
                    !e.target.closest('.badge-item') &&
                    !e.target.closest('.achievement-card') &&
                    !e.target.closest('.toggle-switch')) {
                    e.preventDefault();
                }
            });

            // Initialize the app
            initializeApp();
        });
    </script>
</body>
</html>